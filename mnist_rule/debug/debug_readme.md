# Current problem

- The first SATNet layer's output of configurations (let's call them pred_configs) is probabilistic (but faily similar), however, the maxsat solver is giving very different ansewers (call them solved_configs) -- solved_configs != pred_configs; 

- If we limit the solver to solve in the top 20 configs space, the pred_config is not optimal among the top 20 configs

# Current model used

Best accuracy: 97.09%

Hierachical with 2 SATNet layers, m=200, aux=50 (for both layers), hidden_dimension=8 (length of the first layer's output), stride=7 (16 patches of 7*7 blocks), loss=ce, lr=0.002, seed=123

# Analysis steps

## Obtain the C matrix

The weight was saved to mnist/output/mnist/modelxxxxxxxx and copied to the /mnist/debug folder in best_model.pt
The C matrix is constructed by running (with default parameter)
```
python3 mnist_rule/save_cmatrix.py
```
The resulted C matrix will be saved to mnist/output/mnist/modelxxxxxxxx, but we have copied it to the debug folder as well (it contains two c matrices, one for each SATNet layer)

## Obtain the weighted maxsat files

Common weighted constraints (for layer 1) can be generated by 

```
python3 mnist_rule/mix2sat.py --stack_i 1 --mulitplier 0.2
```

The resulting file will be save again in the model folder but is copied to the debug folder, called "common_w1.txt"

### Note: 
multiplier=0.05 => ~4K constraints
multiplier=0.1 => ~9K constraints
multiplier=0.2 => ~13K constraints (this takes about 40 min to solve for 16 patches)

mulitplier=0.2 is the one used for the saved logs, and multiplier=0.2 showed that the solved configs are fairly consistent on the blank patch (all except for one gave the 01011101 config for the 00000000 predicted config -- will be mentioned later)


## main debugging file

The main debugging file is \textbf{test_solver.py}

### Note: 

1. Some of the paths are hard-coded

2. The code in this file is mainly copy-pasted from multiple larger files, just to show a complete process of predicting and solving for ONE image from the test dataset


```
python3 mnist_rule/test_solver.py --solve True

```

To reproduce the comparison for prediction and solving for the "2" image, put --solve True (the current weight threshold that generates common constraints is 0.2 which gives 13K constraints, and the current threshold for turning a predicted config into binary is 0.4), If puzzles are already constructed and only extraction is needed, remove the --solve argument (for some reason putting --solve False will not work which is quite strange...)

This file will save the results in the debug/debug_results folder, with the patches visualized and all the puzzles with their solutions.

An example of aggregated results was save in excel file here under the tab solver_verification: https://docs.google.com/spreadsheets/d/19Os1GV9IkET-3uOyTyrcwUGpdj45UCHuwxDQoIhVUMU/edit?usp=sharing

Another set of examples can be found in /debug/debug_results1, terminal outputs are collected in debug_results_output_1209_1.txt


## Restricted space

```
python3 mnist_rule/test_sol_space.py
```

This file constructs puzzles that plugs in each of the top 23 (for some reason top 23 configs were collected...) configs and evaluates the results. A sample collected results can be found in the excel linked above -- the predicted config 00000000 is not optimal even in the top 23 space.



